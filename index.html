<!DOCTYPE html>
<meta charset="UTF-8">
<html ng-app>
<head>
	<script src="lib/jquery-1.10.2.js"></script>
	<script src="lib/angular-1.0.7.js"></script>
	<!--script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.4.min.js"></script-->
	<script src="lib/kinetic.js"></script>
	<link rel="stylesheet" type="text/css" href="lib/style.css" media="screen">
</head>
<script>
	function Ctrl($scope){
		$scope.addWebImage = function(){
			console.log('name: ',$scope.webName);
			$scope.addImage('http://static.giantbomb.com/uploads/original/0/5370/1499438-mkdd_banana.jpg');
		}
		$scope.addLocalImage = function(){
			console.log('name: ',$scope.localName);
			$scope.addImage('images/'+$scope.localName+'.png');
		}
		
 	   $scope.addImage = function(url){
			$scope.storePositions();
			$scope.pics.push({url:url});
			
			var loadedImages = 0;
			var images = {};
			var numImages = $scope.pics.length;
			
			
			for(index in $scope.pics){
				images[index] = new Image();
				images[index].onload = function() {
					if(++loadedImages >= numImages){
						drawImages(images);
					}
				}
				images[index].onerror = function(){
					console.log('failed to load');
					$scope.pics.splice(-1,1);
				}
				images[index].src = $scope.pics[index].url;
			}
		}
		function drawImages(images) { 
			console.log('drawImage: ',images);
			var stage = new Kinetic.Stage({
			  container: "container",
			  width: $(document).width()-5,//1600,
			  height: $(document).height()-200
			});
			var layer = new Kinetic.Layer();
			for (index in images){
				var img = new Kinetic.Image({
					  image: images[index],
					  x: $scope.pics[index].x || stage.getWidth() / 2 - 200 / 2,
					  y: $scope.pics[index].y || stage.getHeight() / 2 - 137 / 2,
					  width: $scope.pics[index].width || 100,
					  height: $scope.pics[index].height || 100,
					  draggable: true,
					  id: index
					});
				$scope.images[index] = img;
				img.on('mouseover', function() {
				  document.body.style.cursor = 'pointer';
				});
				img.on('mouseout', function() {
				  document.body.style.cursor = 'default';
				});
				img.on('dragend', function() {
				  document.body.style.cursor = 'default';
				});
				layer.add(img);
			}
			stage.add(layer);
			$scope.stage = stage;
		}
		$scope.storePositions = function(){
			for(index in $scope.pics){
				$scope.pics[index].x = $scope.images[''+index].getAbsolutePosition().x;
				$scope.pics[index].y = $scope.images[''+index].getAbsolutePosition().y;
			}
		}
	}
</script> 

<body ng-controller="Ctrl" ng-init="pics=[];images={};">
	</br><input type="text" placeholder="Search Web" ng-model="webName"></input>
	<input type="text" placeholder="Search Local" ng-model="localName"></input></br>
	<h1 ng-click = "addWebImage();" >Click to Load Web Image</h1>
	<h1 ng-click = "addLocalImage();" >Click to Load Local Image</h1>
	<div id="container"></div>
</body>
</html>